# Perf å¾®æ¶æ§‹æ¨¡æ“¬å™¨æ¶æ§‹è¨­è¨ˆ

## 1. ç³»çµ±æ¦‚è¿°èˆ‡è¨­è¨ˆç›®æ¨™

Perf æ˜¯ä¸€å€‹**é«˜åº¦æ¨¡çµ„åŒ–çš„å¾®æ¶æ§‹CPUæ¨¡æ“¬å™¨æ•ˆèƒ½æ¨¡å‹**ï¼Œæ ¸å¿ƒç›®æ¨™æ˜¯ï¼š

- ğŸ§© æä¾›å¯è‡ªç”±çµ„è£çš„CPUéƒ¨ä»¶ï¼ˆæµæ°´ç·šã€å¿«å–ã€åˆ†æ”¯é æ¸¬å–®å…ƒç­‰ï¼‰
- ğŸ”Œ èˆ‡åŠŸèƒ½æ¨¡æ“¬å™¨ï¼ˆå¦‚Sail-RISC-Vï¼‰ç„¡ç¸«é›†æˆ
- ğŸ“Š å¯¦ç¾ç²¾ç´°åŒ–çš„æ•ˆèƒ½è¿½è¹¤èˆ‡åˆ†æ
- ğŸš€ æ”¯æŒå¿«é€ŸåŸå‹è¨­è¨ˆèˆ‡æ¶æ§‹æ¢ç´¢

è¨­è¨ˆåŸå‰‡ï¼š
1. **ç·¨è­¯æœŸå¤šæ…‹**ï¼šé›¶é‹è¡Œæ™‚é–‹éŠ·çš„æ¥å£ç´„æŸ
2. **é¬†æ•£è€¦åˆ**ï¼šçµ„ä»¶é–“é€šéæ˜ç¢ºå®šç¾©çš„æ¥å£é€šä¿¡
3. **å¯æ“´å±•æ€§**ï¼šæ˜“æ–¼æ·»åŠ æ–°çµ„ä»¶æˆ–æ›¿æ›ç¾æœ‰å¯¦ç¾

## 2. åˆ†å±¤æ¶æ§‹

```mermaid
graph TD
    A[åŠŸèƒ½æ¨¡æ“¬å™¨å±¤] -->|èª¿ç”¨C API| B[Perfæ¨¡å‹æ¥å£å±¤]
    B --> C[æ ¸å¿ƒçµ„ä»¶å±¤]
    C --> D[æ™‚é˜ç³»çµ±]
    C --> E[æ ¸å¿ƒè™•ç†å–®å…ƒ]
    C --> F[æŒ‡ä»¤ç³»çµ±]
    C --> G[...æ“´å±•çµ„ä»¶]
    
    D --> H[æ™‚é˜æ¦‚å¿µ]
    E --> I[æ ¸å¿ƒæ¦‚å¿µ]
    F --> J[æŒ‡ä»¤æ± ]
    F --> K[æŒ‡ä»¤é¡å‹]
    
    G --> L[æµæ°´ç·š]
    G --> M[å¿«å–ç³»çµ±]
    G --> N[åˆ†æ”¯é æ¸¬]
```

æ¶æ§‹èªªæ˜ï¼š
1. **åŠŸèƒ½æ¨¡æ“¬å™¨å±¤**ï¼šSail-RISC-Vç­‰åŸºç¤æ¨¡æ“¬å™¨
2. **Perfæ¨¡å‹æ¥å£å±¤**ï¼šæä¾›Cèªè¨€APIä¾›æ¨¡æ“¬å™¨èª¿ç”¨
3. **æ ¸å¿ƒçµ„ä»¶å±¤**ï¼š
   - åŸºç¤çµ„ä»¶ï¼ˆæ™‚é˜/æ ¸å¿ƒ/æŒ‡ä»¤ï¼‰
   - å¯æ“´å±•çµ„ä»¶ï¼ˆæµæ°´ç·š/å¿«å–ç­‰ï¼‰

## 3. æ ¸å¿ƒçµ„ä»¶æ¥å£å®šç¾©

### 3.1 æ™‚é˜ç³»çµ±æ¥å£ï¼ˆClockConceptï¼‰
```cpp
// src/Clock/Concept/ClockConcept.h
template <typename T>
struct ClockConcept {
    // å¿…é ˆå¯¦ç¾çš„æ¥å£
    static constexpr bool value = 
        std::is_same_v<void, decltype(std::declval<T>().tick())>;
};
```

### 3.2 æ ¸å¿ƒè™•ç†å–®å…ƒæ¥å£ï¼ˆCoreConceptï¼‰
```cpp
// src/Core/Concept/CoreConcept.h
template <typename T>
struct CoreConcept {
    static constexpr bool value = 
        std::is_same_v<void, 
            decltype(std::declval<T>().read_inst(
                static_cast<Instruction*>(nullptr)))>;
};
```

### 3.3 æŒ‡ä»¤ç³»çµ±é—œéµçµæ§‹
```cpp
// src/Instruction/Instruction.h
struct Instruction {
    // æŒ‡ä»¤å…ƒæ•¸æ“š
    uint64_t addr;          // æŒ‡ä»¤åœ°å€
    InstructionType type;   // æŒ‡ä»¤é¡å‹
    RegNum rs1, rs2, rd;    // å¯„å­˜å™¨æ“ä½œæ•¸
    
    // åŸ·è¡Œç‹€æ…‹
    uint64_t rs1_val, rs2_val; // å¯„å­˜å™¨å€¼
    bool taken;             // åˆ†æ”¯æ˜¯å¦è·³è½‰
    
    // æŒ‡ä»¤åˆ†é¡æ–¹æ³•
    bool is_load();
    bool is_store();
    bool is_branch();
    ExecutionUnitType get_execution_unit_type();
};
```

### 3.4 æ¨¡å‹æ¥å£å±¤APIï¼ˆperf_model.hï¼‰
```cpp
// model_interface/perf_model.h
extern "C" {
    // æŒ‡ä»¤ç”Ÿå‘½é€±æœŸäº‹ä»¶
    unit createInstrForStageInfo();
    unit sendInstToPipeline();
    
    // å…§å­˜è¨ªå•äº‹ä»¶
    unit read_addr(uint64_t addr);
    unit read_ls_addr(uint64_t addr);
    
    // å¯„å­˜å™¨è¨ªå•äº‹ä»¶
    unit read_rs_val(uint64_t rs1_val, uint64_t rs2_val);
    
    // åˆ†æ”¯é æ¸¬äº‹ä»¶
    unit read_taken(bool taken);
}
```

## 4. é—œéµè¨­è¨ˆæ¨¡å¼

### 4.1 ç­–ç•¥æ¨¡å¼ï¼ˆå¯æ›¿æ›çµ„ä»¶ï¼‰
```cpp
// æ™‚é˜çµ„ä»¶çš„ç­–ç•¥å¯¦ç¾
template <ClockConcept Clock>
class Processor {
    Clock clock;
public:
    void run_cycle() {
        clock.tick(); // å¯æ›¿æ›ä¸åŒæ™‚é˜å¯¦ç¾
    }
};
```

### 4.2 ç·¨è­¯æœŸå¤šæ…‹ï¼ˆSFINAEï¼‰
```cpp
// ç·¨è­¯æœŸæª¢æŸ¥çµ„ä»¶æ˜¯å¦ç¬¦åˆæ¥å£
template <typename T>
enable_if_t<ClockConcept<T>::value>
use_clock(T& clock) {
    clock.tick(); // åƒ…ç•¶ç¬¦åˆClockConceptæ™‚ç·¨è­¯
}
```

### 4.3 è§€å¯Ÿè€…æ¨¡å¼ï¼ˆäº‹ä»¶æ•ç²ï¼‰
```sail
// Sailæ¨¡æ“¬å™¨ä¸­çš„äº‹ä»¶è§¸ç™¼
function step_instruction() {
    // ...
    read_rs_val(rs1_val, rs2_val); // é€šçŸ¥Perfå¯„å­˜å™¨è®€å–
    read_addr(mem_addr);           // é€šçŸ¥Perfå…§å­˜è¨ªå•
    // ...
}
```

## 5. æ•¸æ“šæµèˆ‡æ§åˆ¶æµ

### 5.1 æŒ‡ä»¤ç”Ÿå‘½é€±æœŸæ•¸æ“šæµ
```mermaid
sequenceDiagram
    participant Sail as Sailæ¨¡æ“¬å™¨
    participant PerfAPI as Perfæ¥å£å±¤
    participant Core as æ ¸å¿ƒçµ„ä»¶
    
    Sail->>PerfAPI: createInstrForStageInfo()
    PerfAPI->>Core: å‰µå»ºæŒ‡ä»¤è¿½è¹¤
    Sail->>PerfAPI: read_rs_val(rs1, rs2)
    PerfAPI->>Core: è¨˜éŒ„å¯„å­˜å™¨å€¼
    Sail->>PerfAPI: read_addr(mem_addr)
    PerfAPI->>Core: è¨˜éŒ„å…§å­˜è¨ªå•
    Sail->>PerfAPI: sendInstToPipeline()
    PerfAPI->>Core: å®ŒæˆæŒ‡ä»¤è¿½è¹¤
```

### 5.2 æ§åˆ¶æµç¤ºä¾‹ï¼ˆæ™‚é˜é©…å‹•ï¼‰
```mermaid
flowchart TD
    A[æ™‚é˜tick] --> B{æ ¸å¿ƒç‹€æ…‹}
    B -->|ç©ºé–’| C[å–æŒ‡]
    B -->|å¿™ç¢Œ| D[åŸ·è¡Œ]
    C --> E[è§£ç¢¼]
    E --> F[åŸ·è¡Œ]
    F --> G[å¯«å›]
    G --> H[æ›´æ–°PC]
    H --> A
```

## 6. è¨­è¨ˆæ±ºç­–ç†ç”±

### 6.1 ç·¨è­¯æœŸæ¥å£æª¢æŸ¥ï¼ˆSFINAEï¼‰
- âœ… **é›¶é‹è¡Œæ™‚é–‹éŠ·**ï¼šæ¥å£åˆè¦æ€§åœ¨ç·¨è­¯éšæ®µé©—è­‰
- âœ… **å¼·é¡å‹å®‰å…¨**ï¼šé¿å…é‹è¡Œæ™‚é¡å‹éŒ¯èª¤
- âœ… **æ¸…æ™°éŒ¯èª¤è¨Šæ¯**ï¼šç·¨è­¯å¤±æ•—æ™‚æ˜ç¢ºæŒ‡å‡ºç¼ºå¤±æ¥å£

### 6.2 C/C++æ··åˆç·¨ç¨‹
- âœ… **Sailå…¼å®¹æ€§**ï¼šSailç”Ÿæˆçš„Cä»£ç¢¼å¯ç›´æ¥èª¿ç”¨
- âœ… **æ€§èƒ½è€ƒé‡**ï¼šCæ¥å£æœ€å°åŒ–èª¿ç”¨é–‹éŠ·
- âœ… **éš”é›¢æ€§**ï¼šC++å¯¦ç¾ç´°ç¯€å°Sailé€æ˜

### 6.3 æ¨¡å¡ŠåŒ–çµ„ä»¶è¨­è¨ˆ
- âœ… **å¯æ“´å±•æ€§**ï¼šè¼•é¬†æ·»åŠ æ–°çµ„ä»¶ï¼ˆå¦‚Cache/BPUï¼‰
- âœ… **å¯æ›¿æ›æ€§**ï¼šçµ„ä»¶å¯¦ç¾å¯ç†±æ’æ‹”
- âœ… **æ¸¬è©¦å‹å¥½**ï¼šçµ„ä»¶å¯ç¨ç«‹æ¸¬è©¦

### 6.4 åŸºæ–¼äº‹ä»¶çš„æ•ˆèƒ½è¿½è¹¤
- âœ… **ç²¾ç´°åº¦**ï¼šæ•ç²æŒ‡ä»¤ç´šåˆ¥äº‹ä»¶
- âœ… **ä½ä¾µå…¥æ€§**ï¼šSailæ¨¡æ“¬å™¨åªéœ€å°‘é‡ä¿®æ”¹
- âœ… **æ•¸æ“šè±å¯Œ**ï¼šæ”¯æŒå¤šç¶­åº¦æ•ˆèƒ½åˆ†æ

## 7. æœªä¾†æ“´å±•æ–¹å‘

1. **æµæ°´ç·šæ¨¡çµ„**ï¼šå¯¦ç¾5ç´šæµæ°´ç·šæ¨¡å‹
2. **åˆ†æ”¯é æ¸¬å–®å…ƒ**ï¼šæ·»åŠ é æ¸¬ç®—æ³•çµ„ä»¶
3. **å¿«å–å±¤ç´š**ï¼šå¯é…ç½®çš„L1/L2ç·©å­˜
4. **å¤šæ ¸æ”¯æŒ**ï¼šæ ¸å¿ƒé–“é€šä¿¡èˆ‡ä¸€è‡´æ€§å”è­°